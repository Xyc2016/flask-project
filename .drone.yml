# kind: pipeline
# type: kubernetes # Note, it's where your runners run.
# name: build-push

# steps:
#   - name: docker-build
#     image: plugins/docker
#     volumes:
#       - name: dockersock
#         path: /var/run
#     settings:
#       repo: 192.168.49.2:5000/fstack-be
#       tags:
#         - ${DRONE_COMMIT_SHA:0:8}
#         - latest
#       registry: 192.168.49.2:5000
#       insecure: true
#     when:
#       event: [push]

# services:
#   - name: docker
#     image: docker:dind
#     privileged: true
#     command: ["sh", "-c", "dockerd --insecure-registry 192.168.49.2:5000"]
#     volumes:
#       - name: dockersock
#         path: /var/run

# volumes:
#   - name: dockersock
#     temp: {}
# ---
kind: pipeline
type: kubernetes
name: deploy-prod

# trigger:
#   event:
#     - promote
steps:
  - name: deploy-prod
    image: bitnami/kubectl:1.33.1
    commands:
      - echo $KUBE_SERVER $KUBE_TOKEN $KUBE_CA_CERT
      - echo "$KUBE_CA_CERT" > /tmp/ca.crt
      - kubectl --server=$KUBE_SERVER --token=$KUBE_TOKEN --certificate-authority=/tmp/ca.crt get deployment
      - kubectl --server=$KUBE_SERVER --token=$KUBE_TOKEN --certificate-authority=/tmp/ca.crt set image deployment/fstack-be fstack-be=192.168.49.2:5000/fstack-be:${DRONE_COMMIT_SHA:0:8}
    environment:
      KUBE_SERVER: https://kubernetes.default.svc
      KUBE_TOKEN:
        from_secret: kube_token
      KUBE_CA_CERT:
        from_secret: kube_ca_cert

# kube_token kube_ca_cert 都在drone repo settings里填写了
